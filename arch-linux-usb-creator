#!/bin/bash

# Arch Linux USB Creator
# Copyright (C) 2014  Branislav Hol√Ω <brano.holy@gmail.com>
#
# This file is part of Arch Linux USB Creator.
#
# Arch Linux USB Creator is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Arch Linux USB Creator is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Arch Linux USB Creator.  If not, see <http://www.gnu.org/licenses/>.

echo "Arch Linux USB Creator"

if [ -n "$1" ]; then
	if [ ! -b "$1" ]; then
		echo "Error: Partition option is not set to block device."
		exit
	fi
else
	echo "Error: Missing partition option (see README.md file)!"
	exit
fi

partition=$1
device=${partition:0: -1}
partitionNumber=${partition: -1}

if [ -n "$2" ]; then
	if [ -f "$2" ]; then
		download=false
		isoPath=$2
	elif [ -d "$2" ]; then
		download=true
		downloadDir=$2
	else
		echo "Error: Wrong path to ISO or to download directory!"
		exit
	fi
else
	download=true
	downloadDir=/tmp
fi

if $download; then
	echo "Downloading the latest Arch Linux ISO."

	. mirrors.conf

	if [ -z "$mirror" ]; then
		echo "Error: You have to set mirror variable in mirrors.conf file (see README.md file)!"
		exit
	fi

	cwd=`pwd`
	cd "$downloadDir"

	mirrorDir="$mirror/iso/latest"

	wget $mirrorDir -O archlinux-iso-index.html
	isoName=`sed "s/.*\(archlinux-[0-9\.]\+-dual\.iso\).*/\1/" archlinux-iso-index.html | grep dual.iso | tail -1`
	rm archlinux-iso-index.html

	wget "$mirrorDir/$isoName" -O "$isoName"
	wget "$mirrorDir/sha1sums.txt" -O archlinux-iso-sha1sums.txt

	cat archlinux-iso-sha1sums.txt | grep dual.iso | sha1sum -c --status
	if [ "$?" == "0" ]; then
		isoPath="$downloadDir/$isoName"
		rm archlinux-iso-sha1sums.txt
		cd "$cwd"
	else
		echo "Error: SHA1SUM does not match!"
		rm archlinux-iso-sha1sums.txt
		rm "$isoName"
		exit
	fi
fi

mkdir -p /mnt/arch-iso
mount -o loop "$isoPath" /mnt/arch-iso

mkdir -p /mnt/arch-usb
mount "$partition" /mnt/arch-usb

cp -a /mnt/arch-iso/* /mnt/arch-usb

sed -i "s|label=ARCH_.*|device=/dev/disk/by-uuid/$(blkid -o value -s UUID $partition)|" /mnt/arch-usb/arch/boot/syslinux/archiso_sys{32,64}.cfg /mnt/arch-usb/loader/entries/archiso-x86_64.conf

cp -r /usr/lib/syslinux/bios/*.c32 /mnt/arch-usb/arch/boot/syslinux
extlinux --install /mnt/arch-usb/arch/boot/syslinux

sync
umount /mnt/arch-iso
umount /mnt/arch-usb
rmdir /mnt/arch-iso
rmdir /mnt/arch-usb

if $download; then
	rm "$isoPath"
fi

sfdisk -A$partitionNumber $device
dd bs=440 count=1 conv=notrunc if=/usr/lib/syslinux/bios/mbr.bin of=$device

echo "Arch Linux USB Creator: Done"

